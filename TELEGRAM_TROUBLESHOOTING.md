# Решение проблем с Telegram уведомлениями

## Возможные причины, почему боты не получают уведомления:

### 1. **TELEGRAM_BOT_TOKEN не установлен**

**Проблема:** Переменная окружения `TELEGRAM_BOT_TOKEN` не настроена в Vercel.

**Решение:**
1. Откройте Vercel Dashboard → Ваш проект → Settings → Environment Variables
2. Добавьте переменную:
   - **Name:** `TELEGRAM_BOT_TOKEN`
   - **Value:** `8393509629:AAEIogSE6Z5ltFvWYt8TPDi0EtoNBMlWzio` (ваш токен)
3. Перезапустите деплой

**Проверка:**
- Откройте консоль браузера (F12) при отправке уведомления
- Проверьте логи в Vercel Dashboard → Functions → Logs

### 2. **Неправильный Chat ID (Ошибка: "chat not found")**

**Проблема:** Chat ID указан неправильно, бот не запущен пользователем, или пользователь заблокировал бота.

**Решение:**
1. **Получите правильный Chat ID:**
   - Напишите боту @userinfobot в Telegram
   - Или используйте @getidsbot
   - Скопируйте число (Chat ID, например: `123456789`)

2. **ВАЖНО: Запустите бота перед использованием:**
   - Откройте вашего бота в Telegram
   - Отправьте команду `/start`
   - Бот должен ответить приветственным сообщением
   - Только после этого Chat ID будет работать!

3. **Проверьте Chat ID:**
   - Откройте страницу склада → вкладка "Bot sozlamalari"
   - Введите Chat ID
   - Нажмите кнопку **"Test qilish"**
   - Если тест успешен (✅), нажмите "Saqlash"
   - Если тест не прошел (❌), проверьте:
     - Правильность Chat ID
     - Запущен ли бот командой `/start`
     - Не заблокирован ли бот пользователем

**Проверка:**
- Откройте страницу склада → вкладка "Bot sozlamalari"
- Убедитесь, что Chat ID сохранен и отображается
- Используйте кнопку "Test qilish" для проверки перед сохранением

### 3. **Бот не запущен или не работает**

**Проблема:** Бот на Railway не запущен или упал.

**Решение:**
1. Проверьте логи в Railway Dashboard
2. Убедитесь, что бот запущен и отвечает на команды
3. Отправьте `/start` боту в Telegram - он должен ответить

### 4. **Ошибки API Telegram**

**Проблема:** Telegram API возвращает ошибки (неверный токен, чат не найден и т.д.).

**Типичные ошибки:**
- `401 Unauthorized` - неверный токен бота
- `400 Bad Request: chat not found` - неверный Chat ID
- `403 Forbidden` - бот заблокирован пользователем

**Решение:**
1. Проверьте токен бота в [@BotFather](https://t.me/botfather)
2. Убедитесь, что пользователь не заблокировал бота
3. Отправьте боту `/start` перед использованием

### 5. **Проблемы с форматом сообщения**

**Проблема:** Markdown форматирование вызывает ошибки.

**Решение:**
- Код автоматически обрабатывает ошибки форматирования
- Если проблема сохраняется, проверьте логи в консоли

## Отладка

### Проверка в браузере:
1. Откройте консоль разработчика (F12)
2. Попробуйте отправить уведомление
3. Проверьте ошибки в консоли

### Проверка на сервере:
1. Vercel Dashboard → Functions → Logs
2. Найдите запросы к `/api/orders/notify-telegram`
3. Проверьте ошибки в логах

### Тестовая отправка:
Используйте кнопку "Botlarga tarqatish" в админ-панели для тестовой отправки.

## Быстрая проверка:

1. ✅ Токен установлен в Vercel?
2. ✅ Chat ID сохранен в базе данных?
3. ✅ Бот отвечает на `/start` в Telegram?
4. ✅ Пользователь не заблокировал бота?
5. ✅ Проверены логи в консоли браузера и Vercel?

## Пример правильной настройки:

1. **Vercel Environment Variables:**
   ```
   TELEGRAM_BOT_TOKEN=8393509629:AAEIogSE6Z5ltFvWYt8TPDi0EtoNBMlWzio
   ```

2. **База данных (Supabase):**
   ```sql
   UPDATE restaurants 
   SET telegram_chat_id = '123456789' 
   WHERE id = 'ваш-id-склада';
   ```

3. **Проверка:**
   - Откройте админ-панель → Заказы
   - Нажмите "Botlarga tarqatish"
   - Выберите бот из списка
   - Проверьте, что уведомление пришло

