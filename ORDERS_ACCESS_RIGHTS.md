# Права доступа к заказам

## Кто может управлять заказами?

### 1. **Создание заказов (INSERT)**
- ✅ **Авторизованные пользователи** - любые пользователи (customer, manager, super_admin и т.д.)
- ✅ **Неавторизованные пользователи** - анонимные заказы (user_id = NULL)

### 2. **Просмотр заказов (SELECT)**

#### Супер-админ (`super_admin`)
- ✅ Может видеть **все заказы** (через функцию `is_manager()`)
- ✅ Доступ к странице `/admin/orders`

#### Менеджер (`manager`)
- ✅ Может видеть **все заказы** (через функцию `is_manager()`)
- ✅ Доступ к странице `/manager/orders`

#### Клиент (`customer`)
- ✅ Может видеть **только свои заказы**
- ✅ Доступ к странице `/customer/orders`

#### Сборщик (`collector`)
- ✅ Может видеть **только назначенные ему заказы**
- ✅ Доступ к странице `/collector/orders`

#### Курьер (`courier`)
- ✅ Может видеть **готовые заказы** (status = 'ready')
- ✅ Может видеть **назначенные ему заказы**
- ✅ Доступ к странице `/courier/orders`

### 3. **Обновление заказов (UPDATE)**

#### Супер-админ (`super_admin`)
- ✅ Может обновлять **любые заказы** (через функцию `is_manager()`)
- ✅ Может изменять статус, назначать сборщиков и курьеров

#### Менеджер (`manager`)
- ✅ Может обновлять **любые заказы** (через функцию `is_manager()`)
- ✅ Может изменять статус, назначать сборщиков и курьеров

#### Сборщик (`collector`)
- ✅ Может обновлять **только назначенные ему заказы**
- ✅ Может изменять статус на: `collecting`, `ready`
- ❌ Не может изменять другие статусы

#### Курьер (`courier`)
- ✅ Может обновлять **только назначенные ему заказы**
- ✅ Может изменять статус на: `assigned_to_courier`, `delivering`, `delivered`
- ❌ Не может изменять другие статусы

#### Клиент (`customer`)
- ❌ Не может обновлять заказы

### 4. **Удаление заказов (DELETE)**
- ❌ **Никто не может удалять заказы** через RLS политики
- ⚠️ Удаление возможно только через прямые SQL запросы (не рекомендуется)

## Функции проверки прав

### `is_manager()`
Возвращает `true` для:
- `super_admin`
- `manager`

### `is_super_admin()`
Возвращает `true` только для:
- `super_admin`

## Текущие RLS политики

Политики определены в файлах:
- `supabase/02_rls_policies_safe.sql` - основные политики
- `supabase/16_fix_orders_rls.sql` - исправления для анонимных заказов

## Рекомендации

1. **Супер-админ** имеет полный доступ ко всем заказам
2. **Менеджер** имеет полный доступ ко всем заказам (как супер-админ)
3. **Сборщики и курьеры** имеют ограниченный доступ только к назначенным заказам
4. **Клиенты** могут только создавать и просматривать свои заказы

