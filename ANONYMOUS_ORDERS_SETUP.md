# Настройка анонимных заказов (без регистрации)

## Что изменилось

Теперь пользователи могут оформлять заказы **без регистрации**. Регистрация стала опциональной для обычных клиентов.

---

## Шаги для применения изменений

### 1. Выполните SQL миграции в Supabase

Откройте Supabase SQL Editor и выполните **по порядку**:

1. **`supabase/07_allow_anonymous_orders.sql`**
   - Делает `user_id` опциональным в таблице `orders`
   - Добавляет поле `customer_email` для анонимных заказов

2. **`supabase/08_update_rls_for_anonymous_orders.sql`**
   - Обновляет RLS политики для разрешения создания заказов без авторизации
   - Разрешает создание `order_items` для анонимных заказов

---

## Как это работает

### Для неавторизованных пользователей:

1. Могут просматривать меню и добавлять товары в корзину
2. Могут оформить заказ, указав:
   - Адрес доставки
   - Телефон
   - Email (опционально, но рекомендуется)
   - Примечания
3. После оформления видят страницу успеха с номером заказа
4. **Не могут** просматривать список своих заказов (только через номер заказа)

### Для авторизованных пользователей:

1. Все то же самое, что и для неавторизованных
2. **Могут** просматривать список своих заказов на `/customer/orders`
3. Email автоматически подставляется из профиля

---

## Что видит менеджер

Менеджеры видят **все заказы**, включая:
- Заказы авторизованных пользователей
- Анонимные заказы (где `user_id = NULL`)

В анонимных заказах будет указан `customer_email` (если был указан при оформлении).

---

## Важные моменты

1. **Анонимные заказы** имеют `user_id = NULL` и `customer_email` (если указан)
2. **Авторизованные заказы** имеют `user_id` и могут иметь `customer_email` (для уведомлений)
3. Менеджеры, сборщики и курьеры работают с заказами как обычно
4. Анонимные пользователи не могут отслеживать заказы через интерфейс (только через номер заказа)

---

## Проверка

После применения миграций:

1. Выйдите из системы (или откройте в режиме инкогнито)
2. Добавьте товары в корзину
3. Перейдите на `/customer/cart` → "Оформить заказ"
4. Заполните форму (регистрация не требуется)
5. Оформите заказ
6. Должна открыться страница успеха с номером заказа

---

## Откат изменений (если нужно)

Если нужно вернуть обязательную регистрацию:

```sql
-- Вернуть NOT NULL для user_id
ALTER TABLE orders 
ALTER COLUMN user_id SET NOT NULL;

-- Удалить поле customer_email
ALTER TABLE orders 
DROP COLUMN IF EXISTS customer_email;

-- Вернуть старые RLS политики (из 02_rls_policies_safe.sql)
```

Но это не рекомендуется, так как ухудшит пользовательский опыт.


